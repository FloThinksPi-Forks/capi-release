#!/usr/bin/env bash

<%
  def discover_external_ip
    networks = spec.networks.marshal_dump

    _, network = networks.find do |_name, network_spec|
      network_spec.default
    end

    if !network
      _, network = networks.first
    end

    if !network
      raise "Could not determine IP via network spec: #{networks}"
    end

    network.ip
  end
%>

RUN_DIR=/var/vcap/sys/run/cloud_controller_ng
PIDFILE="${RUN_DIR}/ccng_monit_http_healthcheck.pid"
CC_PIDFILE="${RUN_DIR}/cloud_controller_ng.pid"

HOST=<%= p('cc.nginx.ip').empty? ? discover_external_ip : p('cc.nginx.ip') %>
PORT=<%= p("cc.external_port") %>

source /var/vcap/packages/capi_utils/pid_utils.sh

pid_guard "${PIDFILE}" "Cloud Controller HTTP Healthcheck"

echo $$ > "${PIDFILE}"

# wait until cloud_controller_ng process is at least running
while ! pid_is_running < ${CC_PIDFILE}; do
  sleep 1;
done

# if we fail to curl it 5 times in a row across 50 seconds, die so monit will restart us
while true; do
  set -e
  curl \
    --max-time <%= p('cc.api_health_check_timeout_per_retry') %> \
    --retry 5 \
    --retry-delay 10 \
    http://${HOST}:${PORT}/v2/info
done